<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEIL | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background: #0a0a0f; color: #00ff88; }
        .card { background: rgba(20, 20, 30, 0.9); border: 1px solid #00ff8840; border-radius: 8px; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .log-row { border-bottom: 1px solid #333; transition: background 0.3s; }
        .log-row:hover { background: #1a1a2a; }
        .status-allowed { color: #00ff88; }
        .status-blocked { color: #ff4444; }
    </style>
</head>
<body class="min-h-screen p-6">
    <header class="mb-8">
        <h1 class="text-4xl font-bold tracking-wider">VEIL <span class="text-gray-500">COMMAND CENTER</span></h1>
        <p class="text-gray-500">Real-Time Security Observability</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Metric Cards -->
        <div class="card p-6">
            <p class="text-gray-500 text-sm mb-1">TOTAL REQUESTS</p>
            <p id="total" class="text-5xl font-bold">0</p>
        </div>
        <div class="card p-6">
            <p class="text-gray-500 text-sm mb-1">ALLOWED</p>
            <p id="allowed" class="text-5xl font-bold status-allowed">0</p>
        </div>
        <div class="card p-6">
            <p class="text-gray-500 text-sm mb-1">BLOCKED</p>
            <p id="blocked" class="text-5xl font-bold status-blocked">0</p>
        </div>

        <!-- Live Chart -->
        <div class="card p-6 md:col-span-2">
            <p class="text-gray-500 text-sm mb-4">TRAFFIC FLOW</p>
            <canvas id="chart" height="150"></canvas>
        </div>

        <!-- System Status -->
        <div class="card p-6">
            <p class="text-gray-500 text-sm mb-4">SYSTEM STATUS</p>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span>Engine</span>
                    <span id="status-engine" class="pulse">●</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>OPA</span>
                    <span id="status-opa" class="pulse">●</span>
                </div>
                <div class="flex justify-between items-center">
                    <span>Ollama</span>
                    <span id="status-ollama" class="pulse">●</span>
                </div>
            </div>
        </div>

        <!-- Live Logs -->
        <div class="card p-6 md:col-span-3">
            <p class="text-gray-500 text-sm mb-4">LIVE FEED</p>
            <div class="overflow-auto max-h-64">
                <table class="w-full text-sm">
                    <thead class="text-gray-500">
                        <tr>
                            <th class="text-left py-2">TIME</th>
                            <th class="text-left py-2">PATH</th>
                            <th class="text-left py-2">STATUS</th>
                            <th class="text-left py-2">LATENCY</th>
                        </tr>
                    </thead>
                    <tbody id="logs">
                        <tr class="log-row"><td colspan="4" class="py-2 text-gray-600">Waiting for data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-center text-gray-600 text-sm">
        VEIL Security Platform | Powered by Deterministic AI
    </footer>

    <script>
        const chartData = { allowed: [], blocked: [] };
        const chartLabels = [];
        let chart;

        async function fetchStats() {
            try {
                const res = await fetch('/api/v1/stats');
                const data = await res.json();

                document.getElementById('total').textContent = data.total_requests;
                document.getElementById('allowed').textContent = data.allowed_count;
                document.getElementById('blocked').textContent = data.blocked_count;

                // Update Chart
                const now = new Date().toLocaleTimeString();
                chartLabels.push(now);
                chartData.allowed.push(data.allowed_count);
                chartData.blocked.push(data.blocked_count);

                if (chartLabels.length > 20) {
                    chartLabels.shift();
                    chartData.allowed.shift();
                    chartData.blocked.shift();
                }
                chart.update();

                // Update Logs
                const logsEl = document.getElementById('logs');
                logsEl.innerHTML = data.recent_logs.map(log => `
                    <tr class="log-row">
                        <td class="py-2">${new Date(log.timestamp * 1000).toLocaleTimeString()}</td>
                        <td class="py-2">${log.path}</td>
                        <td class="py-2 ${log.status === 200 ? 'status-allowed' : 'status-blocked'}">${log.status}</td>
                        <td class="py-2">${log.latency}ms</td>
                    </tr>
                `).join('');

                document.getElementById('status-engine').style.color = '#00ff88';
            } catch (e) {
                document.getElementById('status-engine').style.color = '#ff4444';
            }
        }

        // Initialize Chart
        const ctx = document.getElementById('chart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    { label: 'Allowed', data: chartData.allowed, borderColor: '#00ff88', tension: 0.3, fill: false },
                    { label: 'Blocked', data: chartData.blocked, borderColor: '#ff4444', tension: 0.3, fill: false }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#888' } } },
                scales: {
                    x: { ticks: { color: '#555' }, grid: { color: '#222' } },
                    y: { ticks: { color: '#555' }, grid: { color: '#222' } }
                }
            }
        });

        // Poll every 2 seconds
        fetchStats();
        setInterval(fetchStats, 2000);
    </script>
</body>
</html>
