version: '3.8'

services:
  # Layer 0: The Smart Valve (Mitmproxy)
  # Role: Intercepts all outgoing traffic from Agents
  veil-proxy-v2:
    image: mitmproxy/mitmproxy:10.2.0
    container_name: veil-proxy-v2
    command: [ "sh", "-c", "pip install aiohttp && mitmdump -s /app/core/mitm/proxy.py --listen-host 0.0.0.0 --listen-port 8080 --showhost" ]
    volumes:
      - ./:/app
    ports:
      - "8090:8080" # Proxy Port (Changed to 8090 to avoid conflict)
      - "8081:8081" # Web Interface (if used)
    environment:
      - REFLEX_ENGINE_URL=http://veil-engine:8000
    depends_on:
      - veil-engine
    networks:
      - veil-net-phase1

  # Layers 1-5: The Reflex Engine (The Nervous System)
  # Role: Fast, Async Decision Engine
  veil-opa:
    image: openpolicyagent/opa:latest
    ports:
      - "8181:8181"
    command: "run --server --addr :8181 --log-level debug /policies"
    volumes:
      - ./core/policies:/policies
    networks:
      - veil-net-phase1

  veil-ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - veil-net-phase1

  veil-engine:
    image: python:3.11-slim
    container_name: veil-engine
    working_dir: /app
    command: sh -c "pip install -e . && uvicorn core.reflex.main:app --host 0.0.0.0 --port 8000"
    volumes:
      - ./:/app
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8000:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - OPA_URL=http://veil-opa:8181/v1/data/veil/allow
      - ENV=dev
    depends_on:
      - redis
    networks:
      - veil-net-phase1

  # Layer 7 Storage: Memory & Queue
  redis:
    image: redis:7-alpine
    container_name: veil-redis
    ports:
      - "6379:6379"
    networks:
      - veil-net-phase1

volumes:
  ollama_data:


networks:
  veil-net-phase1:
    driver: bridge
